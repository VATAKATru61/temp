{% extends "base.html" %}

{% block title %}Главная | SoloBot WEB{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>
        <i class="fas fa-tachometer-alt"></i>
        Главная панель
    </h1>
    <p class="page-subtitle">Обзор системы и основные метрики</p>
</div>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Statistics Cards -->
    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-users"></i>
                </div>
            </div>
            <div class="stat-value">{{ stats.total_users or 0 }}</div>
            <div class="stat-label">Всего пользователей</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up stat-change-icon"></i>
                +{{ stats.users_today or 0 }} сегодня
            </div>
        </div>
        
        <div class="stat-card success">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-key"></i>
                </div>
            </div>
            <div class="stat-value">{{ stats.total_subs or 0 }}</div>
            <div class="stat-label">Активных подписок</div>
            <div class="stat-change neutral">
                <i class="fas fa-clock stat-change-icon"></i>
                {{ stats.expired_subs or 0 }} истекших
            </div>
        </div>
        
        <div class="stat-card warning">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-credit-card"></i>
                </div>
            </div>
            <div class="stat-value">{{ "%.2f"|format(stats.payments_sum or 0) }}₽</div>
            <div class="stat-label">Общий доход</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up stat-change-icon"></i>
                +{{ "%.2f"|format(stats.payments_sum_today or 0) }}₽ сегодня
            </div>
        </div>
        
        <div class="stat-card info">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-server"></i>
                </div>
            </div>
            <div class="stat-value">{{ stats.servers_available or 0 }}</div>
            <div class="stat-label">Доступных серверов</div>
            <div class="stat-change neutral">
                <i class="fas fa-power-off stat-change-icon"></i>
                {{ stats.servers_disabled or 0 }} отключено
            </div>
        </div>
        
        <div class="stat-card danger">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-share-alt"></i>
                </div>
            </div>
            <div class="stat-value">{{ stats.total_refs or 0 }}</div>
            <div class="stat-label">Рефералов</div>
            <div class="stat-change positive">
                <i class="fas fa-arrow-up stat-change-icon"></i>
                +{{ stats.refs_today or 0 }} сегодня
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-header">
                <div class="stat-icon">
                    <i class="fas fa-gift"></i>
                </div>
            </div>
            <div class="stat-value">{{ stats.total_gifts or 0 }}</div>
            <div class="stat-label">Подарков</div>
            <div class="stat-change neutral">
                <i class="fas fa-check stat-change-icon"></i>
                {{ stats.gifts_used or 0 }} использовано
            </div>
        </div>
    </div>
    
    <!-- Charts Container -->
    <div class="charts-container">
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Рост пользователей</h3>
                    <p class="chart-subtitle">За последние 30 дней</p>
                </div>
                <div class="chart-actions">
                    <button class="chart-filter active" data-period="30">30 дней</button>
                    <button class="chart-filter" data-period="7">7 дней</button>
                    <button class="chart-filter" data-period="1">Сегодня</button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="usersChart" width="400" height="200"></canvas>
            </div>
        </div>
        
        <div class="chart-card">
            <div class="chart-header">
                <div>
                    <h3 class="chart-title">Активность подписок</h3>
                    <p class="chart-subtitle">Новые подписки по дням</p>
                </div>
                <div class="chart-actions">
                    <button class="chart-filter active" data-period="30">30 дней</button>
                    <button class="chart-filter" data-period="7">7 дней</button>
                </div>
            </div>
            <div class="chart-content">
                <canvas id="subscriptionsChart" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Quick Actions -->
    <div class="quick-actions">
        <a href="/users" class="quick-action">
            <div class="quick-action-icon">
                <i class="fas fa-user-plus"></i>
            </div>
            <h4 class="quick-action-title">Добавить пользователя</h4>
            <p class="quick-action-description">Создать нового пользователя в системе</p>
        </a>
        
        <a href="/keys" class="quick-action">
            <div class="quick-action-icon">
                <i class="fas fa-key"></i>
            </div>
            <h4 class="quick-action-title">Управление ключами</h4>
            <p class="quick-action-description">Просмотр и управление ключами</p>
        </a>
        
        <a href="/servers" class="quick-action">
            <div class="quick-action-icon">
                <i class="fas fa-server"></i>
            </div>
            <h4 class="quick-action-title">Настройка серверов</h4>
            <p class="quick-action-description">Управление серверами и их настройками</p>
        </a>
        
        <a href="/payments" class="quick-action">
            <div class="quick-action-icon">
                <i class="fas fa-chart-line"></i>
            </div>
            <h4 class="quick-action-title">Аналитика</h4>
            <p class="quick-action-description">Просмотр статистики и отчетов</p>
        </a>
    </div>
    
    <!-- System Status -->
    <div class="system-status">
        <div class="status-card">
            <div class="status-header">
                <h4 class="status-title">Использование CPU</h4>
                <div class="status-indicator"></div>
            </div>
            <div class="status-value">45%</div>
            <div class="status-label">Средняя загрузка</div>
            <div class="status-progress">
                <div class="status-progress-bar">
                    <div class="status-progress-fill" style="width: 45%"></div>
                </div>
                <div class="status-progress-text">
                    <span>0%</span>
                    <span>100%</span>
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-header">
                <h4 class="status-title">Использование RAM</h4>
                <div class="status-indicator warning"></div>
            </div>
            <div class="status-value">72%</div>
            <div class="status-label">8.2 GB / 16 GB</div>
            <div class="status-progress">
                <div class="status-progress-bar">
                    <div class="status-progress-fill warning" style="width: 72%"></div>
                </div>
                <div class="status-progress-text">
                    <span>0 GB</span>
                    <span>16 GB</span>
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-header">
                <h4 class="status-title">Дисковое пространство</h4>
                <div class="status-indicator success"></div>
            </div>
            <div class="status-value">28%</div>
            <div class="status-label">142 GB / 500 GB</div>
            <div class="status-progress">
                <div class="status-progress-bar">
                    <div class="status-progress-fill success" style="width: 28%"></div>
                </div>
                <div class="status-progress-text">
                    <span>0 GB</span>
                    <span>500 GB</span>
                </div>
            </div>
        </div>
        
        <div class="status-card">
            <div class="status-header">
                <h4 class="status-title">Сетевая активность</h4>
                <div class="status-indicator"></div>
            </div>
            <div class="status-value">1.2 MB/s</div>
            <div class="status-label">Текущая скорость</div>
            <div class="status-progress">
                <div class="status-progress-bar">
                    <div class="status-progress-fill" style="width: 35%"></div>
                </div>
                <div class="status-progress-text">
                    <span>0 MB/s</span>
                    <span>10 MB/s</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Recent Activity -->
    <div class="activity-feed">
        <div class="activity-header">
            <h3 class="activity-title">
                <i class="fas fa-clock"></i>
                Последняя активность
            </h3>
            <div class="activity-filter">
                <button class="activity-filter-btn active">Все</button>
                <button class="activity-filter-btn">Пользователи</button>
                <button class="activity-filter-btn">Платежи</button>
                <button class="activity-filter-btn">Системы</button>
            </div>
        </div>
        
        <div class="activity-list" id="activityList">
            <!-- Активность будет загружена динамически -->
            <div class="activity-item">
                <div class="activity-icon success">
                    <i class="fas fa-user-plus"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-message">Пользователь ID:12345 зарегистрировался</div>
                    <div class="activity-time">Только что</div>
                    <div class="activity-meta">
                        <span class="activity-badge success">Пользователи</span>
                    </div>
                </div>
            </div>
            
            <div class="activity-item">
                <div class="activity-icon info">
                    <i class="fas fa-credit-card"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-message">Платеж 299₽ от пользователя @username</div>
                    <div class="activity-time">3 минуты назад</div>
                    <div class="activity-meta">
                        <span class="activity-badge info">Платежи</span>
                    </div>
                </div>
            </div>
            
            <div class="activity-item">
                <div class="activity-icon success">
                    <i class="fas fa-key"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-message">Создан ключ для пользователя ID:12340</div>
                    <div class="activity-time">15 минут назад</div>
                    <div class="activity-meta">
                        <span class="activity-badge success">Ключи</span>
                    </div>
                </div>
            </div>
            
            <div class="activity-item">
                <div class="activity-icon warning">
                    <i class="fas fa-server"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-message">Сервер EU-2 превысил лимит подключений</div>
                    <div class="activity-time">1 час назад</div>
                    <div class="activity-meta">
                        <span class="activity-badge warning">Системы</span>
                    </div>
                </div>
            </div>
            
            <div class="activity-item">
                <div class="activity-icon danger">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="activity-content">
                    <div class="activity-message">Истек ключ пользователя ID:12300</div>
                    <div class="activity-time">2 часа назад</div>
                    <div class="activity-meta">
                        <span class="activity-badge danger">Истечения</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // Chart data from backend
    const usersData = {{ stats.users_growth_month|tojson if stats.users_growth_month else '[]' }};
    const subsData = {{ stats.subs_growth_month|tojson if stats.subs_growth_month else '[]' }};
    const dates = {{ stats.last_30_days|tojson if stats.last_30_days else '[]' }};
    
                        // Users Chart
     const usersChart = new Chart(document.getElementById('usersChart'), {
         type: 'line',
         data: {
             labels: dates,
             datasets: [{
                 label: 'Новые пользователи',
                 data: usersData,
                 borderColor: '#2563eb',
                 backgroundColor: 'rgba(37, 99, 235, 0.1)',
                 fill: true
             }]
         },
         options: {
             responsive: true,
             maintainAspectRatio: false,
             plugins: {
                 legend: {
                     display: false
                 }
             },
             scales: {
                 y: {
                     beginAtZero: true,
                     grid: {
                         color: 'rgba(0, 0, 0, 0.1)'
                     }
                 },
                 x: {
                     grid: {
                         display: false
                     }
                 }
             },
             elements: {
                 line: {
                     tension: 0.4
                 },
                 point: {
                     radius: 4,
                     hoverRadius: 6
                 }
             }
         }
     });
     
     // Subscriptions Chart
     const subscriptionsChart = new Chart(document.getElementById('subscriptionsChart'), {
         type: 'line',
         data: {
             labels: dates,
             datasets: [{
                 label: 'Новые подписки',
                 data: subsData,
                 borderColor: '#10b981',
                 backgroundColor: 'rgba(16, 185, 129, 0.1)',
                 fill: true
             }]
         },
         options: {
             responsive: true,
             maintainAspectRatio: false,
             plugins: {
                 legend: {
                     display: false
                 }
             },
             scales: {
                 y: {
                     beginAtZero: true,
                     grid: {
                         color: 'rgba(0, 0, 0, 0.1)'
                     }
                 },
                 x: {
                     grid: {
                         display: false
                     }
                 }
             },
             elements: {
                 line: {
                     tension: 0.4
                 },
                 point: {
                     radius: 4,
                     hoverRadius: 6
                 }
             }
         }
     });
    
    // Chart filter functionality
    document.querySelectorAll('.chart-filter').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from siblings
            this.parentElement.querySelectorAll('.chart-filter').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Update chart data based on period
            const period = this.dataset.period;
            updateChartData(period);
        });
    });
    
                   function updateChartData(period) {
         // Симуляция данных для разных периодов
         let newUsersData, newSubsData, newLabels;
         
         if (period === '1') {
             // Данные за сегодня (по часам)
             newLabels = ['00:00', '04:00', '08:00', '12:00', '16:00', '20:00'];
             newUsersData = [2, 5, 8, 12, 15, 18];
             newSubsData = [1, 3, 5, 7, 9, 11];
         } else if (period === '7') {
             // Данные за 7 дней
             newLabels = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
             newUsersData = [25, 30, 28, 35, 40, 45, 38];
             newSubsData = [15, 18, 16, 22, 25, 28, 24];
         } else {
             // Данные за 30 дней (исходные)
             newLabels = dates;
             newUsersData = usersData;
             newSubsData = subsData;
         }
         
         // Обновляем график пользователей
         usersChart.data.labels = newLabels;
         usersChart.data.datasets[0].data = newUsersData;
         usersChart.update();
         
         // Обновляем график подписок
         subscriptionsChart.data.labels = newLabels;
         subscriptionsChart.data.datasets[0].data = newSubsData;
         subscriptionsChart.update();
     }
    
    // Activity filter functionality
    document.querySelectorAll('.activity-filter-btn').forEach(button => {
        button.addEventListener('click', function() {
            // Remove active class from siblings
            this.parentElement.querySelectorAll('.activity-filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Add active class to clicked button
            this.classList.add('active');
            
            // Filter activity items
            const filter = this.textContent.toLowerCase();
            filterActivityItems(filter);
        });
    });
    
              function filterActivityItems(filter) {
         const items = document.querySelectorAll('.activity-item');
         
         items.forEach(item => {
             if (filter === 'все') {
                 item.style.display = 'flex';
             } else {
                 const badge = item.querySelector('.activity-badge');
                 const badgeText = badge ? badge.textContent.toLowerCase() : '';
                 
                 // Проверяем соответствие фильтра
                 let shouldShow = false;
                 
                 if (filter === 'пользователи' && badgeText.includes('пользователи')) {
                     shouldShow = true;
                 } else if (filter === 'платежи' && badgeText.includes('платежи')) {
                     shouldShow = true;
                 } else if (filter === 'системы' && (badgeText.includes('системы') || badgeText.includes('ключи'))) {
                     shouldShow = true;
                 }
                 
                 item.style.display = shouldShow ? 'flex' : 'none';
             }
         });
     }
    
    // Auto-refresh dashboard data every 30 seconds
    setInterval(() => {
        // This would typically fetch fresh data from the server
        console.log('Refreshing dashboard data...');
    }, 30000);
    
    // Animate stat cards on load
    document.addEventListener('DOMContentLoaded', function() {
        const statCards = document.querySelectorAll('.stat-card');
        statCards.forEach((card, index) => {
            setTimeout(() => {
                card.style.opacity = '0';
                card.style.transform = 'translateY(20px)';
                card.style.transition = 'all 0.5s ease-out';
                
                setTimeout(() => {
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 100);
            }, index * 100);
        });
    });
    
    // Real-time updates simulation
    function simulateRealTimeUpdates() {
        const indicators = document.querySelectorAll('.status-indicator');
        
        indicators.forEach(indicator => {
            // Simulate status changes
            setInterval(() => {
                const random = Math.random();
                if (random < 0.1) {
                    indicator.classList.add('warning');
                    setTimeout(() => {
                        indicator.classList.remove('warning');
                    }, 2000);
                }
            }, 5000);
        });
    }
    
    // Initialize real-time updates
    simulateRealTimeUpdates();
</script>
{% endblock %}
