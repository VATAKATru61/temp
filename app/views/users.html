{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ | SoloBot WEB{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/users.css">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
    <p class="page-subtitle">–í—Å–µ–≥–æ: {{ total_users }}</p>
</div>
{% endblock %}

{% block content %}
<div class="table-container">
    <div class="search-container">
        <input type="text" id="userSearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, username –∏–ª–∏ ID..." />
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th>tg_id</th>
                <th>–ò–º—è</th>
                <th>Username</th>
                <th>–ë–∞–ª–∞–Ω—Å</th>
                <th>Trial</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for user in users %}
            <tr>
                <td>{{ user.tg_id }}</td>
                <td>{{ user.first_name or "-" }}</td>
                <td>@{{ user.username or "‚Äî" }}</td>
                <td>{{ user.balance }}</td>
                <td>{{ user.trial }}</td>
                <td>
                    <button onclick='openEditModal({{ user | tojson | safe }})' class="btn btn-sm">‚úèÔ∏è</button>
                    <button onclick="openDeleteModal('{{ user.tg_id }}')" class="btn btn-sm btn-danger">üóëÔ∏è</button>
                    <a href="/users/{{ user.tg_id }}" class="btn btn-sm btn-secondary" title="–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å">‚û°Ô∏è</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal" id="editModal">
    <div class="modal-content">
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h2>
        <form id="editUserForm">
            <input type="hidden" id="edit-tg_id">

            <div class="form-group">
                <label for="edit-balance">–ë–∞–ª–∞–Ω—Å:</label>
                <input type="number" id="edit-balance" step="0.01">
            </div>

            <div class="form-group">
                <label for="edit-trial">Trial:</label>
                <input type="number" id="edit-trial">
            </div>

            <div class="form-buttons">
                <button type="submit" class="btn btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" onclick="closeEditModal()" class="btn btn-sm btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="deleteModal">
    <div class="modal-content">
        <p>–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è <span id="delete-user-id"></span>?</p>
        <button onclick="confirmDelete()" class="btn btn-sm btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        <button onclick="closeDeleteModal()" class="btn btn-sm btn-secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    let selectedUserId = null;

    function openEditModal(user) {
        selectedUserId = user.tg_id;
        document.getElementById('edit-tg_id').value = user.tg_id;
        document.getElementById('edit-balance').value = user.balance;
        document.getElementById('edit-trial').value = user.trial;
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editUserForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const tg_id = document.getElementById('edit-tg_id').value;
        const formData = {
            balance: document.getElementById('edit-balance').value,
            trial: document.getElementById('edit-trial').value
        };

        const payload = {};
        for (const [key, value] of Object.entries(formData)) {
            if (value !== "" && value !== null) {
                if (key === "balance") payload[key] = parseFloat(value);
                else if (key === "trial") payload[key] = parseInt(value);
                else payload[key] = value;
            }
        }

        const res = await fetch(`/users/${tg_id}?tg_id={{ admin_tg_id }}`, {
            method: "PATCH",
            headers: {
                "Content-Type": "application/json",
                "X-Token": "{{ token }}"
            },
            body: JSON.stringify(payload)
        });

        if (res.ok) {
            location.reload();
        } else {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        }
    });

    function openDeleteModal(tg_id) {
        selectedUserId = tg_id;
        document.getElementById('delete-user-id').innerText = tg_id;
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function closeDeleteModal() {
        document.getElementById('deleteModal').style.display = 'none';
    }

    async function confirmDelete() {
        const res = await fetch(`/users/${selectedUserId}`, {
            method: "DELETE"
        });

        if (res.ok) {
            location.reload();
        } else {
            alert("‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        }
    }

    document.getElementById('userSearchInput').addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        const rows = document.querySelectorAll('.data-table tbody tr');

        rows.forEach(row => {
            const cells = row.querySelectorAll('td');
            const match = Array.from(cells).some(cell =>
                cell.textContent.toLowerCase().includes(filter)
            );
            row.style.display = match ? '' : 'none';
        });
    });
</script>
{% endblock %}
