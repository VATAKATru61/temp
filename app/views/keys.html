{% extends "base.html" %}

{% block title %}–ö–ª—é—á–∏ | SoloBot WEB{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="/static/css/tariffs.css">
{% endblock %}

{% block header %}
<div class="page-header">
    <h1>–ü–æ–¥–ø–∏—Å–∫–∏</h1>
    <p class="page-subtitle">–í—Å–µ–≥–æ: {{ total_keys }}</p>
</div>
{% endblock %}

{% block content %}
<div class="table-container">
    <div class="search-container" style="display: flex; align-items: center; justify-content: space-between; gap: 1rem;">
        <input type="text" id="keySearchInput" placeholder="üîç –ü–æ–∏—Å–∫ –ø–æ email –∏–ª–∏ uuid..." style="flex:1;">
        <button class="btn btn-sm btn-danger" id="delete-selected-keys" style="white-space: nowrap;">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ</button>
    </div>

    <table class="data-table">
        <thead>
            <tr>
                <th><input type="checkbox" id="select-all-keys"></th>
                <th>TG_ID</th>
                <th>UUID</th>
                <th>Email</th>
                <th>–î–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è</th>
                <th>–ö–ª–∞—Å—Ç–µ—Ä</th>
                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
            </tr>
        </thead>
        <tbody>
            {% for k in keys %}
            <tr>
                <td><input type="checkbox" class="key-checkbox" value="{{ k.email }}"></td>
                <td>{{ k.tg_id }}</td>
                <td>{{ k.client_id }}</td>
                <td>{{ k.email }}</td>
                <td>{{ k.expiry_time_human }}</td>
                <td>{{ k.server_id or '‚Äî' }}</td>
                <td>
                    <button class="btn-edit" data-key='{{ k | tojson | safe }}' onclick="openEditModalFromButton(this)">
                        <i class="fas fa-edit"></i>
                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                    </button>
                    <button onclick='openDeleteModal("{{ k.email }}")' class="btn-delete">
                        <i class="fas fa-trash"></i>
                        –£–¥–∞–ª–∏—Ç—å
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>


<div class="modal" id="editModal">
    <div class="modal-content">
        <h2>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–ª—é—á</h2>
        <form id="editKeyForm">
            <input type="hidden" id="edit-original_client_id">
            <input type="hidden" id="edit-tg_id">

            <div class="form-group">
                <label>Email:</label>
                <input type="text" id="edit-email">
            </div>
            <input type="hidden" id="edit-expiry_time">
            <div class="form-group">
                <label>Expiry Date:</label>
                <input type="datetime-local" id="edit-expiry_date">
            </div>
            <div class="form-group">
                <label>Cluster (server_id):</label>
                <input type="text" id="edit-server_id">
            </div>
            <div class="form-group">
                <label>Remnawave Link:</label>
                <input type="text" id="edit-remnawave_link">
            </div>
            <div class="form-group">
                <label>Tariff ID:</label>
                <input type="number" id="edit-tariff_id" min="0">
            </div>
            <div class="form-group">
                <label>–ó–∞–º–æ—Ä–æ–∂–µ–Ω:</label>
                <select id="edit-is_frozen">
                    <option value="false">–ù–µ—Ç</option>
                    <option value="true">–î–∞</option>
                </select>
            </div>
            <div class="form-group">
                <label>Alias:</label>
                <input type="text" id="edit-alias">
            </div>

            <div class="form-buttons">
                <button type="submit" class="btn btn-sm">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button type="button" onclick="closeEditModal()" class="btn btn-sm btn-secondary">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </form>
    </div>
</div>

<div class="modal" id="deleteModal">
    <div class="modal-content">
        <p>–£–¥–∞–ª–∏—Ç—å –∫–ª—é—á —Å email <strong><span id="delete-key-email"></span></strong>?</p>
        <button onclick="confirmDelete()" class="btn btn-sm btn-danger">–î–∞, —É–¥–∞–ª–∏—Ç—å</button>
        <button onclick="closeDeleteModal()" class="btn btn-sm btn-secondary">–û—Ç–º–µ–Ω–∞</button>
    </div>
</div>

<script>
    let selectedKey = null;
    const TG_ID = "{{ tg_id or '0' }}";
    const TOKEN = "{{ token or '' }}";

    function openEditModal(key) {
        selectedKey = key;
        document.getElementById('edit-original_client_id').value = key.client_id;
        document.getElementById('edit-tg_id').value = key.tg_id;
        document.getElementById('edit-email').value = key.email || '';
        document.getElementById('edit-expiry_time').value = key.expiry_time || '';
        document.getElementById('edit-server_id').value = key.server_id || '';
        document.getElementById('edit-remnawave_link').value = key.remnawave_link || '';
        document.getElementById('edit-tariff_id').value = key.tariff_id || '';
        document.getElementById('edit-is_frozen').value = key.is_frozen.toString();
        document.getElementById('edit-alias').value = key.alias || '';
        const expiry = key.expiry_time ? new Date(key.expiry_time) : null;
        document.getElementById('edit-expiry_date').value = expiry
            ? expiry.toISOString().slice(0, 16)
            : '';
        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    document.getElementById('editKeyForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const clientId = document.getElementById('edit-original_client_id').value;
        const tgId = document.getElementById('edit-tg_id').value;

        const dateStr = document.getElementById('edit-expiry_date').value;
        let expiry_time = null;
        if (dateStr) {
            expiry_time = new Date(dateStr).getTime();
        }
        document.getElementById('edit-expiry_time').value = expiry_time;
        const payload = {
            email: document.getElementById('edit-email').value,
            expiry_time: expiry_time,
            server_id: document.getElementById('edit-server_id').value || null,
            remnawave_link: document.getElementById('edit-remnawave_link').value || null,
            tariff_id: parseInt(document.getElementById('edit-tariff_id').value, 10) || null,
            is_frozen: document.getElementById('edit-is_frozen').value === 'true',
            alias: document.getElementById('edit-alias').value || null
        };

        Object.keys(payload).forEach(key => {
            if (payload[key] === null) delete payload[key];
        });

        const email = document.getElementById('edit-email').value;
        const res = await fetch(
            `/keys/edit/by_email/${encodeURIComponent(email)}?tg_id=${encodeURIComponent(tgId)}`,
            {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Token': TOKEN
                },
                body: JSON.stringify(payload)
            }
        );
        if (res.ok) location.reload();
        else alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞');
    });

    function openDeleteModal(email) {
        document.getElementById('delete-key-email').innerText = email;
        selectedKey = email;
        document.getElementById('deleteModal').style.display = 'flex';
    }
    function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }
    async function confirmDelete() {
        const res = await fetch(
            `/keys/by_email/${encodeURIComponent(selectedKey)}?tg_id=${TG_ID}`,
            { method: 'DELETE', headers: { 'X-Token': TOKEN } }
        );
        if (res.ok) location.reload();
        else alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–ª—é—á–∞');
    }

    document.getElementById('keySearchInput').addEventListener('input', function () {
        const filter = this.value.toLowerCase();
        document.querySelectorAll('.data-table tbody tr').forEach(row => {
            row.style.display = Array.from(row.querySelectorAll('td'))
                .some(td => td.textContent.toLowerCase().includes(filter))
                ? '' : 'none';
        });
    });

    document.getElementById('select-all-keys').addEventListener('change', function() {
        const checked = this.checked;
        document.querySelectorAll('.key-checkbox').forEach(cb => cb.checked = checked);
    });

    document.getElementById('delete-selected-keys').addEventListener('click', async function() {
        const selected = Array.from(document.querySelectorAll('.key-checkbox:checked')).map(cb => cb.value);
        if (selected.length === 0) {
            alert('–í—ã–±–µ—Ä–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –ø–æ–¥–ø–∏—Å–∫—É –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è.');
            return;
        }
        if (!confirm(`–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ (${selected.length} —à—Ç.)?`)) return;
        let success = true;
        for (const email of selected) {
            const res = await fetch(`/keys/by_email/${encodeURIComponent(email)}?tg_id=${TG_ID}`, {
                method: 'DELETE',
                headers: { 'X-Token': TOKEN }
            });
            if (!res.ok) {
                success = false;
                break;
            }
        }
        if (success) location.reload();
        else alert('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫');
    });

    function openEditModalFromButton(btn) {
        const key = JSON.parse(btn.dataset.key);
        openEditModal(key);
    }
</script>
{% endblock %}
